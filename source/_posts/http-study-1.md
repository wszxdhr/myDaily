---
title: 当你在浏览器地址栏按下回车（上）
date: 2023-12-24 17:06:14
tags: [HTTP,SSL,DNS,TCP,网络]
categories: [网络知识]
references:
  - title: 《图解HTTP》
    url: https://weread.qq.com/web/reader/3da32b505dd9f43da9a1aca
---

当你在浏览器地址栏按下回车，会发生什么呢？

这个问题看似很简单，“不就是通过URL请求网页，然后服务端返回一个网页给你吗？”

但是实际上可没这么简单，如果真这么简单，那大象装冰箱里真就只需要三步了。

{% image /images/20231224-001.png, width=400px %}

<!-- more -->

## 把大象装进冰箱里总共需要几步？

先来笼统介绍一下，请求并展示一个网页资源，都需要经历哪些步骤？

1. 输入URL并按下回车
2. 请求URL的解析（截取域名，进行DNS解析）（Client部分）
3. 与域名对应的IP对应的服务器建立TCP连接（局域网路由器、交换机，互联网路由器、交换机，CDN（缓存），网关、防火墙，最终到达服务器）
4. 请求URL的解析（解析URI，进行响应路由）（Server部分）
5. 向源Client返回响应（利用原TCP连接）
6. Client解析并展示响应

### 第一步：打开冰箱门（发送请求）

我们现在开始进行接力赛~

第一个接棒的是你的电脑，它看着你在它脸上的chrome上点来点去，又噼里啪啦打下了一串URL（如：[https://blog.anymelon.com/s?wd=hello](https://blog.anymelon.com/s?wd=hello)），接着Duang的一声按下了回车。此时它心里是不爽的，好嘛又要开始干活了。

{% image /images/iShot_2023-12-24_21.15.28.png, width=400px %}

它跟chrome盯着这段URL，想了想，决定先把它分成三段，`https://`、`blog.anymelon.com`、`/s?wd=hello`。

获得了域名`blog.anymelon.com`，它开始进行DNS解析，首先会在本地的DNS缓存中查找，如果没有的话，它会向DNS服务器发送一个请求，请求这个域名对应的IP地址。

{% image /images/20231224-your-computer-dns.png, width=600px %}

DNS服务器收到请求后，会返回一个IP地址，这个IP地址就是`blog.anymelon.com`对应的服务器的IP地址。

这个你可以用`nslookup`命令来查看，比如`nslookup blog.anymelon.com`，会返回一个IP地址，这个IP地址就是`blog.anymelon.com`对应的服务器的IP地址。

```shell
❯ nslookup blog.anymelon.com
Server:		192.168.0.2
Address:	192.168.0.2#53

Non-authoritative answer:
Name:	blog.anymelon.com
Address: 116.62.238.68
```

你的电脑知道了服务器对应的IP，首先要看看这个IP是否可以直接通信，通常靠子网掩码来判断，子网掩码可以作为两个设备是否在同一子网的判断依据，这里不展开讲了。

- 如果在同一子网，就先翻翻通讯录（ARP缓存），如果有缓存，则直接向对应的Server请求，没有请求则会发送ARP广播。
  {% image /images/20231224-local-network-arp.png, width=700px %}
- 如果不在同一子网，就需要通过网关（路由器）来进行转发。
  {% image /images/20231224-global-network-request.png, width=700px %}

我们假定不在同一子网（如果在同一子网则略过互联网传输的步骤），现在接力棒交到路由器这里。

{% image /images/20231224-your-computer-access-global-network.png, width=700px %}

### 第二步：把大象放进去（请求的传输）

{% image /images/20231224-make-tcp-connection.png, width=700px %}

接下来就看跳跳虎（路由器）的表现了，路由器最擅长的就是跳跳，它会跳到互联网上，然后跳到CDN上，然后跳到网关上，然后跳到防火墙上，然后跳到服务器上。

{% image /images/20231224-jump-tiger.png, width=200px %}

你家里的路由器大概率也是蒙的，一般不能直接发送到对应服务器的，它找遍了路由表，可能发现根本没有头绪，这时候它只能求助它的网关（ISP（运营商，移动联通电信等）提供的路由器）。

如此就这样，找不到的就向上求助，直到到达顶层骨干路由，还找不到的话就放弃了。

有时候会存在跨ISP的情况（联通用户请求电信的服务器），那就涉及到BGP协议了，大概就是ISP之间的路由协议，两个AS之间互通有无。

假设我们的路由器比较幸运，最终跳到了服务器所在网关，把接力棒交给了服务商网关。

网关拿到这条请求，它手下有很多服务器，它会根据一些策略（比如负载均衡）来决定把这个请求转发到哪个服务器上。

防火墙（网关和服务器上可能都会有）拿到请求会根据自己的安全策略，决定是否要拒绝这条请求，如果拒绝了，那就直接返回一个错误码给路由器，路由器再返回给你的电脑。

如果没有拒绝，那就把接力棒交给服务器。

服务器拿到请求后，会根据请求的URI，来决定返回什么资源，由于建立了TCP请求，所以直接通过TCP返回给客户端。

### 第三步：关上冰箱门（请求响应的解析）

现在接力棒回到了客户端，客户端拿到响应，分析响应头，如果是`200`，那就是成功了（仅代表请求成功，不代表业务成功），如果不是，那就是失败了。

浏览器会分析Content-Type，根据不同的类型使用不同的展现方式。

## 别忘了前置条件

就像空气一般，我们每天都会用到网络，但是网络中的设备、协议，都有人替我们负重前行了。

值得注意的是，网络中不是只有手机、电脑、服务器，还有很多很多的设备，比如路由器、交换机、网卡、网线等等。

而协议也不止HTTP、TCP，也还有ARP、DNS等等。

### 网卡、网线、交换机、路由器

网线（无线电磁波）将你的设备和网络相连，但是直接与你的设备（的网卡）通信的，可能是AP，可能是路由器，也可能是交换机等。

{% image /images/5ac4801bN17c781ee.jpg, width=300px, alt=图片来源：京东 %}

网卡是你的设备和网线相连的接口，它会负责将你的数据包封装成网线可以传输的格式，然后通过网线发送出去。

无线网卡不通过网线连接，是把本来的数据包封装成为无线电使用的格式，无线传输的过程很复杂，种类和标准也很多，一般的设备（终端设备、路由设备都算）都会支持几种不同的协议类型，比如WIFI协议就有802.11a/b/g/n/ac/ax等等。终端和无线路由器建立连接时，会协商使用哪种协议。

{% image /images/20231224-network-card.jpg, width=300px, alt=图片来源：zcool.cn %}

交换机是一个很有意思的设备，它可以将一个网线分成多个网线，也可以将多个网线合并成一个网线，这样就可以实现多个设备之间的通信，而不需要每个设备都连接到路由器上。

{% image /images/20231224-network-switch.jpeg, width=300px, alt=图片来源：tp-link.com.cn %}

路由器上面讲了，其实是一个字面意思上的东西，就是用来寻路的，它会根据路由表，将数据包转发到下一个路由器，直到到达目的地。

我们大多数家用的无线路由器，其实集成了多种功能，比如路由器、交换机、网关、防火墙等等：
1. 普通路由功能：从路由表找到下一跳的路径
2. 交换机功能：将多个网线合并成一个网线
3. 网关功能：将内网和外网连接起来
4. 防火墙功能：其实家用路由器本身也是有防火墙功能的，家用路由器初始化时的默认设置就是不暴露任何端口，只有在你设置了端口映射后，才会暴露端口。

### IP、MAC、ARP

{% image /images/20231224-local-network-arp.png, width=500px %}

你的电脑怎么直到要把数据包发给哪个设备呢？

其实在它发送数据包的时候，”地址“一栏填的是MAC地址而不是IP地址，MAC地址是网卡的唯一标识，每个网卡都有一个唯一的MAC地址，这个地址是由网卡厂商分配的，一般是48位的十六进制数，比如`00:0c:29:4f:8a:9d`。

想找到IP对应的MAC地址，就需要用到ARP协议，ARP协议是一种用来解析IP地址和MAC地址的协议，它会在局域网内广播一个请求，请求对应IP地址的MAC地址，然后对应的设备会回复一个MAC地址。

但是MAC地址是局域网内的地址，如果你要发送数据包到外网，那就需要IP地址了，IP地址是全球唯一的，一般是32位的十进制数，比如`111.111.111.111`

（MAC地址其实理论上也是全球唯一的，为啥说理论上呢，IP（非内网IP）在分配时就要避免与已有IP冲突，如果不经过DHCP而直接自己定义静态IP，那在ARP广播的时候就会产生冲突，而MAC是厂商烧录在网卡上的，理论上厂商不会烧录重复的MAC地址，但是如果厂商不遵守规则，那就会出现重复的MAC地址了）
