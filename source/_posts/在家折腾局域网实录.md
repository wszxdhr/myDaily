---
title: 在家折腾局域网实录(上)
date: 2020-05-16 13:20:26
categories: [电子设备折腾记]
tags: [电子设备,局域网配置]
---

辞职在家一时爽，一直在家一直爽。每天早睡早起的日子实在是太香了！兴致来了煎个牛排喝个牛奶煮个意面小日子美滋滋~

所以是时候搞一波大的了，拆家的快乐不是上班的人能享受到的~

本文记一次给**黑群晖**装**软路由**(OpenWrt)的操作

<!-- more -->

注：文中黑群晖系统：6.1.7，机器为蜗牛星际C款双千兆



## 第一波，黑群晖装软路由安排

这个折腾的由来是无意中看到电信出了免费领取200M宽带，白送实在太香了（虽然要隔几天领一次）。

迅速点击申请！

联网！

测速！

<img src="/images/问号脸.jpg" height="100px"/>

竟然还是100M？老子的六类线和千兆交换机不是开玩笑的，难道你电信骗我？

顺着网线查了一波才想起来我这小米路由4Q是百兆的WAN口，突然脑瓜子就膨胀了

<img src="/images/在家折腾局域网实录/百兆高速小米4Q.jpg" height="150px"/>

咋整

环顾四周，发现了默默躺在电视柜下面的黑群晖，底部ITX主板上面，除了一个插着网线的RJ45口，还黑漆漆的露着一个RJ45

{% fancybox %}
<img src="/images/在家折腾局域网实录/电视柜下的群晖.jpg" height="150px"/>
<img src="/images/在家折腾局域网实录/群晖的俩网口.jpg" height="150px"/>
{% endfancybox %}

对哦，我黑群晖是双千兆的蜗牛星际C款，棒

就你了

开搞！上网线！打开群晖管理！打开VMM虚拟机！

### 折腾前的拓扑图

折腾这个之前家里是一个小米路由做一级路由，上面连光猫（桥接模式，一级路由拨号，顺便拿个外网IP），下面连二级路由，二级路由是个Mesh路由，基本当个AP用了，桥接到一级路由，客厅一个，卧室一个，全以来解决可怜的Wifi信号强度问题，让阳台可怜的洗衣机也能连上网。

以及在小米路由上配置了DDNS和端口映射，可以让外网访问到家里的群晖。另又给小米路由设置了hosts，这样同样一个域名，在家解析到局域网，在外通过外网DNS到家，实现一个域名两个IP，打开Wifi局域网直通，关闭Wifi走DDNS解析。

<img src="/images/在家折腾局域网实录/家中拓扑图曾经1.jpg" style="max-height: 360px;"/>

### 想象之中的折腾后的拓扑图

拆除小米路由器，列入闲鱼清单等待出卖。

用群晖VMM虚拟一个OpenWrt，取代所有小米路由器的功能，其他基本没变，唯一Mesh改成无线连接了，因为测试发现实际上网线没生效(迷)。

由于黑群晖的俩网口都是千兆的，所以都给他用上，就变成一个千兆软路由了。

注：途中OpenWrt是群晖虚拟机虚拟出来的。

<img src="/images/在家折腾局域网实录/家中拓扑图后来2.jpg" style="max-height: 360px;"/>

### 群晖软路由配置（OpenWrt安排）

#### 操作之前

致黑群晖的Owner：操作之前一定要记得一个准则，一定要小心的配置网络，因为一旦玩坏不好救，毕竟黑群晖没有网络Reset按钮。如果不放心可以给群晖的网口配一个DHCP功能(在控制面板中)，就算OpenWrt玩坏了，至少也能连上群晖恢复快照。

#### 软路由

先科普一波软路由

软路由是指利用台式机或服务器配合软件形成路由解决方案，主要靠软件的设置，达成[路由器](https://baike.baidu.com/item/路由器/108294)的功能；而[硬路由](https://baike.baidu.com/item/硬路由/6801739)则是以特有的硬设备，包括处理器、电源供应、[嵌入式软件](https://baike.baidu.com/item/嵌入式软件/5345503)，提供设定的路由器功能。（摘自百度百科）

简单来说就是可以用一台电脑或者Arm设备（树莓派、智能路由等）做网络数据分发、IP分配（DHCP）等工作，如果存在专用硬件（如tplink吹的那种5G模块）甚至可以配置驱动的一种软件+硬件系统，可以替代市面上买到的那种路由，只要性能足够强，最后体验会远高于市面上买到的普通路由（~~感觉说了废话~~），也可以说，一个小米路由装了OpenWrt，会让它性能变得更强，但是对于不会设置的人可能是噩梦。

注：
1. 软路由尽量使用双网口设备，单网口的单臂路由模式(NUC)对硬件性能要求更高
2. 黑群晖的网络设置不当，重置会非常麻烦，因此要谨慎操作

#### 安装OpenWrt映像

这里参考了网上的文章：[https://www.10bests.com/how-to-install-openwrt-on-synology-vmm/](https://www.10bests.com/how-to-install-openwrt-on-synology-vmm/)

相比于我的粗鄙的原因（带宽升级，还是临时的），人家的更换路由原因就正大光明多了：

- 带宽提升
- 无线有线分离方便
- 插件多，可玩性大
- 带机量高

现有专门给群晖VMM用的OpenWrt，扔进去就能跑，这里用的KoolShare的固件，[固件下载链接](http://firmware.koolshare.cn/LEDE_X64_fw867/%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BD%AC%E7%9B%98%E6%88%96PE%E4%B8%8B%E5%86%99%E7%9B%98%E4%B8%93%E7%94%A8/)
选更新日期最新的，且以`combined-squashfs.img.gz`为结尾的链接下载，目前来看如下图箭头指向的：
<img src="/images/在家折腾局域网实录/koolshare固件下载页截图.jpg" height="300px"/>
下载下来解压得到`.img`文件

接下来登录群晖管理界面，打开Virtual Machine Manager(以下简称VMM)(如果没有的话可以套件中心下一个)

先创建映像，到这里有些操作和参考文章不太相同了，如下图操作：

<img src="/images/在家折腾局域网实录/群晖添加映像1.jpg" style="max-height: 300px"/>
选择`.img`文件
<img src="/images/在家折腾局域网实录/群晖添加映像2.jpg" style="max-height: 300px"/>
<img src="/images/在家折腾局域网实录/群晖添加映像3.jpg" style="max-height: 300px"/>

#### 配置虚拟机

然后来添加网络：
<img src="/images/在家折腾局域网实录/群晖添加网络1.jpg" style="max-height: 300px"/>
弹框“创建虚拟交换机”中点击“下一步”，然后：
<img src="/images/在家折腾局域网实录/群晖添加网络2.jpg" style="max-height: 300px"/>
<img src="/images/在家折腾局域网实录/群晖添加网络3.jpg" style="max-height: 300px"/>
然后你就能看到这里多了两个网络：
<img src="/images/在家折腾局域网实录/群晖添加网络4.jpg" style="max-height: 300px"/>

接下来导入虚拟机：
<img src="/images/在家折腾局域网实录/群晖导入虚拟机1.jpg" style="max-height: 300px"/>
<img src="/images/在家折腾局域网实录/群晖导入虚拟机2.jpg" style="max-height: 300px"/>
然后选择想要存储的盘，下一步
<img src="/images/在家折腾局域网实录/群晖导入虚拟机3.jpg" style="max-height: 300px"/>
申请核心当然越多越好，但是为了避免影响群晖系统本身，建议就分个1核或者2核(土豪的4核处理器)
点击下一步时如果出现如下提示，可能说明你不能申请这么多内存，推荐调节到适当内存后再下一步，虚拟机的内存开辟的大小跟实际占用实体机的内存并不是一一对应的，比如虚拟机开辟128MB内存，可能实体机会被占用200MB(只是打个比方，实际应该更猛)，所以群晖系统为了能保证系统本身有足够的内存使用，会对虚拟机开辟的值进行限制
<img src="/images/在家折腾局域网实录/群晖导入虚拟机4.jpg" style="max-height: 300px"/>
接下来“存储空间”设置直接下一步
接下来选择网络，这里踩了个坑，当时以为是随便选局域网1和局域网2的，后来发现是**先LAN后WAN**，所以这里**注意要选择正确顺序**，参照之前添加网络时候的选择，不要选错了，选错了是容易进不去OpenWrt系统的
<img src="/images/在家折腾局域网实录/群晖导入虚拟机5.jpg" style="max-height: 300px"/>
<img src="/images/在家折腾局域网实录/群晖导入虚拟机6.jpg" style="max-height: 300px"/>
<img src="/images/在家折腾局域网实录/群晖导入虚拟机7.jpg" style="max-height: 300px"/>
最后审核一下，没问题就点击`应用`
**注意：如果后续碰到无限重启的问题，可以考虑尝试开启这个选项**：(我这里是灰的，参考文章中式可以勾选的)
<img src="/images/在家折腾局域网实录/群晖导入虚拟机8.jpg" style="max-height: 300px"/>

接下来打开控制面板设置网络，调节并确保你的路由的WAN口所在的局域网端口在最上面，充当默认网关，不然群晖上不去网
<img src="/images/在家折腾局域网实录/控制面板网络设置1.jpg" style="max-height: 300px"/>

然后发现问题不大，就可以去设置虚拟机开机自启了
<img src="/images/在家折腾局域网实录/虚拟机设置1.jpg" style="max-height: 300px"/>

然后启动虚拟机
<img src="/images/在家折腾局域网实录/虚拟机设置2.jpg" style="max-height: 300px"/>

这时有可能碰到一个坑：你的网段不是192.168.1.x，而是像我一样改过的，比如192.168.2.x，那你是没办法直接进入OpenWrt的Web管理界面的。又或者碰到光猫是有IP的，说不定是192.168.1.1，因此也可以顺便改一下IP避免冲突，如果没有这种情况可以跳过
{% folding cyan, 展开显示网段不是默认时的操作 %}

<img src="/images/在家折腾局域网实录/网段问题1.jpg" style="max-height: 300px"/>
连接之后弹出一个黑底白字的命令行网页页面，先按下回车（如果没反应可以尝试多按几下），出现一个符号版OpenWrt的LOGO，然后输入`vi /etc/config/network`
<img src="/images/在家折腾局域网实录/网段问题2.jpg" style="max-height: 300px"/>
进入network配置的编辑页面，按方向键向下移动光标，找到`config interface 'lan'`下面的`option ipaddr '192.168.1.1'`，光标移动到适当位置，按`i`键编辑，将`192.168.1.1`改为你的IP网段地址，如：`192.168.2.1`，然后按“小写冒号wq回车”保存并退出(`:wq`)
<img src="/images/在家折腾局域网实录/网段问题3.jpg" style="max-height: 200px"/>

{% endfolding %}

#### 配置OpenWrt

打开浏览器输入：`192.168.1.1`（不同配置下的IP不同，如上面说的网段不同则可能是`192.168.2.1`等等），在输入密码的地方输入默认密码`koolshare`

<img src="/images/在家折腾局域网实录/openwrt1.jpg" style="max-height: 300px"/>
<img src="/images/在家折腾局域网实录/openwrt2.jpg" style="max-height: 400px"/>
保存配置并重启
<img src="/images/在家折腾局域网实录/openwrt3.jpg" style="max-height: 300px"/>

到此为止，就可以连上网了，剩下的就是其他非必要的就可以自己研究玩了，黑群晖的话切记不要玩脱了，毕竟没有网络Reset功能

### 测速

到了激动人心的测速环节

打开Speedtest！

测速开始！

经过多轮Speedtest测速，基本稳定190Mb/s左右的速度，心满意足~

<img src="/images/熊猫耶.jpg" height="100px"/>

## 总结

完成了一波群晖VMM配置软路由的操作，但是效果不尽人意，2G内存的群晖瞬间败下阵来（最多只能分配170MB左右），物理机内存占用居高不下，但是好在一直没到过顶。(这个问题加钱可解，有钱能给群晖加内存，分配到1G的内存的OpenWrt就基本无敌了，带机量爆棚)

当天我就对OpenWrt做了各种操作，安装一种能无视地形飞到世界各地的插件（~~Docker~~，可以和世界各地的Boy讨论Docker技术），崩了无数次，又无数次从快照中醒来，重启无数次，也被家中领导嫌弃无数次，终于痛定思痛，我决定还是买个物理路由了！

预知后事如何

且听下篇扯淡