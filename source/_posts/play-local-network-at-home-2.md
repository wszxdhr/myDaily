---
title: 在家折腾局域网实录(下)
date: 2020-05-17 11:21:21
categories: [电子设备折腾记]
tags: [电子设备,局域网配置,DNS,网络知识]
---

上回说到，说张某在家中用黑群晖的内个虚拟机啊，装了个OpenWrt，因久久折腾不息，频繁断网，被他家中领导嫌弃，遂改过自新，决定~~求求~~要求领导批钱买个路由器，整整179元人民币啊各位，终于买下了路由器~~（实际上是提前买了生日礼物）~~

这次讲讲新的路由器的配置和家里整体网络的简化

<!-- more -->

## 虚拟机装OpenWrt方案在我家里的问题

其实整体是好的，但是对我来说有两个问题：

- **黑群晖本身内存不高**（买的时候没想着会用虚拟机，就只要了2G内存，后来发现只能分配一百来兆的内存到虚拟机）
- **黑群晖没有网络Reset按钮，一旦玩崩了，恢复起来比较难**（白群晖Reset之后会变回从网口拿路由器分配的IP，就可以访问了，黑群晖恢复也不是不行，我接过一次HDMI到显示器，跑起命令行好像是无法输入的，到一个命令就停住了，一般只能从SSH操作，毕竟我这也是存了点重要数据的（你懂的））

其实对于高端白群晖用户来说没有什么影响，一是有重置按钮，不怕玩崩，二是配置够用，我这个群晖毕竟还兼职做其他奇奇怪怪的功能（比如dsVideo转码啥的），感觉会影响性能

所以在我的撒泼打滚死皮赖脸的求饶之后，领导同意给我批钱买个路由器了，当做提前买个生日礼物了

{% p center, 大写的 %}{% p center large , 开心%}

<img src="/images/熊猫耶.jpg" height="100px"/>

经过十几个小时的漫长等待，终于等到京东小哥给我放到丰巢了

拿回来迅速安排

{% fancybox %}

<img src="/images/在家折腾局域网实录/TP路由盒子.jpg" height="100px"/>

<img src="/images/在家折腾局域网实录/TP路由.jpg" height="100px"/>

{% endfancybox %}

## 配置路由器

照着说明书配置好wifi和宽带，基本上也没有很多其他的设置可配了

配置完电脑端联网并输入`tplogin.cn`，输入管理员密码进入主界面，大概长这样：

<img src="/images/在家折腾局域网实录/TP首页.jpg" style="max-height: 400px;"/>

其实这款带机量官网上讲是2.4G 15个，5G 25个，我还是挺担心的。。。家里要联网的设备还挺多的，餐桌上头的仨Yeelight灯泡平时都不敢上电了

<img src="/images/在家折腾局域网实录/餐桌Yeelight.jpg" height="100px"/>

为了防止它带不动，我买了易展，相当于也是个Mesh路由，等再买了几个设备，补个易展在卧室就好了

配置好基本配置，我开始找我需要的一些特殊配置（端口映射，DDNS，hosts，静态路由）

## 简化家中网络布置

简化后，由于这个TP的信号和信噪比控制得当，决定撤掉卧室和客厅的二级路由，某鱼回血

在卧室最角落的位置测试信号和速度问题都不大，能跑满200M宽带，略有抖动但是完全够用

<img src="/images/在家折腾局域网实录/卧室测速.png" height="300px"/>

这个测速网站时不时给我来个冷幽默，经常我带宽跑到300M的时候还推荐我买他家服务，提速至200M带宽

需求决定折腾，所以也没测5G到LAN千兆情况的极限，毕竟在卧室也没有这么奇怪的需求，大多数群晖访问都是通过有线来的

在客厅用MBP（18款，猜应该是3X3 MIMO）能跑到跟有线差不多的速度，满足

都搞完之后的拓扑图大概是这样

<img src="/images/在家折腾局域网实录/家中拓扑图现在3.jpg" style="max-height: 360px"/>

刚刚有说道配置路由器的特殊配置，当时其他三个都配好了，然后我恍然大悟的发现，

它

没

有

hosts

功

能

用惯了小米的我，竟然忘了这并不是一个硬路由的标配功能

{% p center large , 龟龟%}

完蛋又要折腾了

想办法搞个DNS Server，贼熏熏的眼神又望向了在电视柜角落瑟瑟发抖的黑群晖

就你了宝贝

## 黑群晖搞个DNS Server

先说为啥我要自己映射域名到IP：

基于我想一个域名走天下，在家中使用的域名在公司或者路上也可以访问（比如我自己存的无损曲库，几十G我也不可能随诊携带，但是我手机流量有的是），但是在家中我就想让它更快（公网上行也只有30Mb/s），也省的浪费我的公网网速，所以我想家中和外面用同样域名但是解析到不同IP，因此可以给家里路由设置一个DNS来拦截这个解析（或者像智能路由那样配置hosts就可以），在外是运营商送的DNS来从公网DDNS到家

这里我能想到的方案有仨，分别说说

- 群晖官方套件：DNS Server
- OpenWrt配置Hosts，然后路由器中默认DNS配到OpenWrt
- 在公网搭建一个DNS Server

最开始尝试过OpenWrt配Hosts，但是想到前车之鉴，也与我想让它做旁路由的理念相悖，这样配之后只能网关配到OpenWrt才能走他的hosts，也不想再在终端到路由之间垫太多

所以决定OpenWrt做旁路由，群晖安装DNS Server来担起这个重任

目前OpenWrt旁路由（以下简称旁路由）的任务就是做一种出国旅游的工作（以下简称嘿嘿嘿，主要用来加速Github，方便上去学习代码知识（认真）），由于iOS中把大多数正规嘿嘿嘿APP都ban掉了，但是还有比如Outline还能用，但是它只有酸酸协议没有酸酸乳协议，酸酸协议现在已经不能用了，但是OpenWrt其实是可以用酸酸乳的，之前试过L2TP这种，没几个好用的代理插件（本来有的，后来没了，Wifi设置中的代理设置不满足我随用随开的理念，适合永久配置），后来发现我可以在旁路由上一边酸酸乳连外面，一边提供酸酸的Server，来实现iOS用能从APP Store下载到的正规嘿嘿嘿APP来在家里（以及家外通过DDNS连回来）来嘿嘿嘿了，这个以后有机会可以介绍一波。

网线插到黑群晖的第二个网口，再看路由器上的IP表，发现出现3个从群晖出来的MAC地址（网口1网口2的物理网卡和OpenWrt的虚拟网卡），路由器给它们分别分配了IP，棒

<img src="/images/在家折腾局域网实录/三个IP.jpg" style="max-height: 180px"/>

接下来就是一波DNS Server配置

### DNS Server软件配置

群晖断操作比较简单，详见群晖官方文档就好

简述一下，添加Master区域，然后添加A类解析到局域网IP，大概如下：

<img src="/images/在家折腾局域网实录/dnsserver配置.jpg" style="max-height: 360px"/>

这样群晖是会有一个53端口的，然后登录路由器配置DNS，**记得保存**

<img src="/images/在家折腾局域网实录/dns配置.jpg" style="max-height: 360px"/>

配完之后，确实能实现在家和用移动网络可以分别获取到两个IP了

### 开始崩溃

正当我开心的打起圣贤码，命名变量的时候想搜索一个单词，然后Alfred的有道翻译Workflow请求timeout了，然后发现我的网易云音乐开始一卡一卡加载不完，网页网速狂掉

吓得我赶紧打开Terminal查了一波

先是局域网DNS Server

<img src="/images/在家折腾局域网实录/ghDNSdig慢.jpg" style="max-height: 320px"/>

可以看到底部SERVER： 192.168.66.116#53是我本地DNS

ANSWER SECTION得到一个最终结果IP：13.229.188.59，对这个IP查询，结果显示IP所在地是华盛顿

<img src="/images/在家折腾局域网实录/ghDNSIP查询北美.jpg" style="max-height: 300px"/>

我又把局域网DNS Server撤了，跑了一遍dig

<img src="/images/在家折腾局域网实录/ghDNSdig查询快.jpg" style="max-height: 320px"/>

又查了一波结果IP所在地，是在新加坡

<img src="/images/在家折腾局域网实录/ghDNSIP查询新加坡.jpg" style="max-height: 300px"/>

粗略的用巴掌在屏幕量了一下，距离北美大概一个巴掌，新家坡这边是半个巴掌

那肯定新加坡更快咯~[狗头]

dig命令结果的Query time 差距也巨大（50倍），不过这个问题还好，对于机房位置的巨大区别，这个delay基本是蜉蝣撼大树了

我又试了一波国内的区别，就对刚刚一首2分钟的歌放了10分钟的网易云下手

<img src="/images/在家折腾局域网实录/wyDNS慢.jpg" style="max-height: 300px"/>

这次给的ANSWER SECTION多了几行，经过两次CNAME最终到了A，显示的这个IP 103.126.92.133和底下那个132是香港（亚太）的机房IP

<img src="/images/在家折腾局域网实录/wyDNS快.jpg" style="max-height: 300px"/>

又切回正常DNS，发现给的IP是杭州机房，已经无法用巴掌来比了，一个20km，一个1300km，而且杭州机房是BGP，香港机房估计三网过去都要突破重重阻碍（没有专线的话），不慢才怪

那话说回来为啥这么慢？看起来大概率是某个环节挂到了国外的DNS

从底向上查了一圈，发现之前因为某些原因把OpenWrt上的DNS设置到114.114.114.114（主）和8.8.8.8（备）上去了，而作为DNS Server的黑群晖把OpenWrt设为了默认第一网关（为了旅游），得，赶紧把OpenWrt的DNS设置换回电信本地DNS

{% p center logo large,  燃鹅 %}

当我重新插拔网线来让Mac刷新网络配置之后，我发现局域网DNS又失效了

因为之前是直接在Mac的设置里面输入DNS服务器，这回刷新网络配置之前，我把DNS的IP写到路由器去了

又运行dig发现，它竟然优先走了ipv6的DNS，巧妙地绕过了我的局域网DNS

(这里有个很有趣的现象，就是自从换了ipv6的局域网DNS，dig到music.163.com一直timeout，但是到百度的又能用，很奇怪，本机直接用ping是可以到bgpv6那个地址的)

坑爹

一番折腾，先是发现TPLink的这个路由器在自动DHCPV6的情况下，无法让ipv6的IP固定（ipv4是有静态路由表的），于是改为手动前缀，固定群晖的ipv6地址，把群晖地址录入路由配置中

<img src="/images/在家折腾局域网实录/ipv6大坑1.jpg" style="max-height: 300px"/>

<img src="/images/在家折腾局域网实录/ipv6大坑2.jpg" style="max-height: 300px"/>

{% p red, 注意：这里没有ipv6配置的朋友不会碰到问题 %}

终于好了

开心

<img src="/images/社会阅历上升了.jpg" height="100px"/>



## PRE 总结

一个喜欢折腾的人不会就此罢休的，既然域名是我自己的，我是不是可以给它一个公网DNS Server（如放在阿里云ECS上开个53端口）来解析它呢，顺带尝试自己做DDNS服务（定时向DNS Server发送目前IP，或由DNS Server自己从包中获取（如果有的话）），目前正在尝试中。。。

## 总结

就此我完成了传说中的“因为一根3200频率的内存条配了一个Z390平台”的网络设备版。

马上6月30号就要结束活动了，平时升级200M是可以按小时收费的，反正我也不是天天下载，所以该享受一定要享受好来，不是免费升级我是不会被电信骗钱的

{% p center gray  small, 毕竟，贫穷使我理智 %}
{% p center logo huge,  哼 %}
